<div class="flex flex-col gap-6 p-6 fade-in mb-20">

  @if (!veicolo) {
    <div class="flex flex-col items-center justify-center h-64 gap-3">
      <div class="w-10 h-10 border-4 border-blue-600 border-t-transparent rounded-full"></div>
      <p class="text-grigio-scuro font-medium">Recupero dati veicolo...</p>
    </div>
  }

  @if (veicolo) {
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
      <app-template-titolo-sottotitolo
        [titolo]="'Dettaglio Veicolo'"
        [sottotitolo]="'Targa: ' + veicolo.targaVeicolo">
      </app-template-titolo-sottotitolo>

      <div class="px-4 py-2 rounded-full border text-sm font-bold flex items-center gap-2 shadow-sm"
           [ngClass]="{
             'bg-green-50 text-green-700 border-green-200': veicolo.statusContrattualeVeicolo === 'Disponibile',
             'bg-yellow-50 text-yellow-700 border-yellow-200': veicolo.statusContrattualeVeicolo === 'Noleggiato',
             'bg-red-50 text-red-700 border-red-200': veicolo.statusContrattualeVeicolo === 'In Manutenzione' || veicolo.inManutenzione}">
        <span class="w-2.5 h-2.5 rounded-full"
              [ngClass]="{
                'bg-green-500': veicolo.statusContrattualeVeicolo === 'Disponibile',
                'bg-yellow-500': veicolo.statusContrattualeVeicolo === 'Noleggiato',
                'bg-red-500': veicolo.statusContrattualeVeicolo === 'In Manutenzione' || veicolo.inManutenzione}"></span>
        {{ veicolo.inManutenzione ? 'In Manutenzione' : veicolo.statusContrattualeVeicolo }}
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mt-2">
      <div class="flex flex-col gap-6">
        <div class="bg-white p-2 rounded-2xl shadow-sm border border-slate-200">
          <img [src]="veicolo.urlImmagine ? veicolo.urlImmagine : 'assets/images/placeholder-car.png'"
               class="w-full h-64 object-cover rounded-xl">
        </div>

        @if (veicolo.nomeAziendaAffiliata && veicolo.luogoRitiroDeposito && veicolo.luogoRitiroDeposito.latitudine && veicolo.luogoRitiroDeposito.longitudine) {
          <div class="flex flex-col gap-2">
            <label class="text-sm font-semibold text-grigio-scuro ml-1">Posizione Attuale</label>
            <div class="w-full h-72 rounded-2xl overflow-hidden shadow-sm border border-slate-200 relative group">
              <div id="google-map" class="w-full h-full"></div>
              <div class="absolute bottom-4 left-1/2 -translate-x-1/2 bg-white/90 backdrop-blur px-4 py-1.5 rounded-full text-xs font-medium text-grigio-scuro shadow-sm pointer-events-none">
                Clicca sul marker per ingrandire
              </div>
            </div>
            <p class="text-xs text-grigio-scuro ml-1 flex items-center gap-1">
              <i class="bi-geo-alt-fill"></i>
              {{ veicolo.luogoRitiroDeposito.nomeLuogo }}
            </p>
          </div>
        }
      </div>

      <div class="bg-white p-8 rounded-2xl shadow-sm border border-slate-200 h-fit">

        <h3 class="text-lg font-bold text-slate-800 mb-6 border-b border-slate-100 pb-2">
          Info
        </h3>

        <form (ngSubmit)="associaVeicoloAzienda()" #veicoloForm="ngForm" class="flex flex-col gap-6">

          <div class="flex flex-col gap-2">
            <div class="flex justify-between items-center">
              <label class="text-sm font-semibold text-blu">Azienda Assegnata</label>
              @if (veicolo.nomeAziendaAffiliata) {
                <button (click)="disassociaVeicoloAzienda()" type="button" class="text-xs text-blue-600 hover:underline font-medium">Rimuovi</button>
              }
            </div>

            @if (veicolo.nomeAziendaAffiliata) {
              <div class="w-full px-4 py-3 rounded-xl bg-blue-50 border border-blue-100 text-blue-800 font-bold flex items-center gap-3">
                {{ veicolo.nomeAziendaAffiliata }}
              </div>
            } @else if(!veicolo.inManutenzione) {
              <div class="fade-in">
                <app-scelta-tendina
                  [lista]="aziende"
                  [chiaveVisuale]="'nomeAzienda'"
                  [placeholder]="'Seleziona azienda (o lascia vuoto per nessuna)'"
                  (valoreChange)="aziendaSelezionata = $event">
                </app-scelta-tendina>
                <p class="text-xs text-slate-400 mt-1">
                  Seleziona un'azienda per trasferire il veicolo.
                </p>
              </div>
            } @else {
              <p>Veicolo in manutenzione e quindi non assegnabile</p>
            }
          </div>

          <div class="flex flex-col gap-2">
            <label class="text-sm font-semibold text-blu">Modello</label>
            <div class="w-full px-4 py-3 rounded-xl border border-slate-100 bg-slate-100/50 text-black font-medium select-none">
              {{ veicolo.nomeModello }}
            </div>
          </div>

          <div class="flex flex-col gap-2">
            <label class="text-sm font-semibold text-blu">Alimentazione</label>
            <div class="w-full px-4 py-3 rounded-xl border border-slate-100 bg-slate-100/50 text-black font-medium select-none">
              {{ veicolo.tipoDistribuzioneVeicolo }}
            </div>
          </div>

          <div class="flex flex-col gap-2 mt-2">
            <div class="flex justify-between items-center">
              <label class="text-sm font-semibold text-slate-700">Livello Carburante</label>
              <span class="text-sm font-bold text-slate-800">{{ veicolo.livelloCarburante }}%</span>
            </div>
            <div class="w-full bg-slate-100 rounded-full h-3 overflow-hidden border border-slate-100">
              <div class="h-full rounded-full transition-all duration-1000"
                   [style.width.%]="veicolo.livelloCarburante"
                   [ngClass]="{
                     'bg-red-500': veicolo.livelloCarburante <= 20,
                     'bg-yellow-500': veicolo.livelloCarburante > 20 && veicolo.livelloCarburante <= 50,
                     'bg-green-500': veicolo.livelloCarburante > 50}">
              </div>
            </div>
          </div>
          <div class="flex items-center justify-end gap-3 mt-6 pt-6 border-t border-slate-100">
            <button type="button" (click)="tornaIndietro()"
                    class="px-6 py-2.5 rounded-xl border border-slate-200 text-slate-600 font-semibold hover:bg-slate-50 transition-all">
              Annulla
            </button>
            <button type="submit" [disabled]="!veicoloForm.valid"
                    class="px-8 py-2.5 rounded-xl bg-blue-600 text-white font-semibold hover:bg-blue-700 active:scale-95 transition-all disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2">
              <i class="bi-save"></i> Salva Modifiche
            </button>
          </div>
        </form>
      </div>
    </div>
  }
</div>
